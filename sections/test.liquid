{% comment %}
DS Scroll Scrub Lottie
Desktop + Mobile JSON support
Uses lottie-web + scroll position mapping
{% endcomment %}

<style>
#shopify-section-{{ section.id }} .ds-scroll-wrapper {
  height: {{ section.settings.scroll_height }}vh;
  position: relative;
}

#shopify-section-{{ section.id }} .ds-lottie-sticky {
  position: sticky;
  top: 0;
  height: 100vh;
  overflow: hidden;
}

#shopify-section-{{ section.id }} .ds-lottie-container {
  width: 100%;
  height: 100%;
}
</style>

<section class="ds-scroll-lottie-section">
  <div id="ds-scroll-{{ section.id }}" class="ds-scroll-wrapper">
    <div class="ds-lottie-sticky">
      <div
        id="ds-lottie-{{ section.id }}"
        class="ds-lottie-container">
      </div>
    </div>
  </div>
</section>

<!-- Load lottie-web ONCE -->
<script>
if (!window.dsLottieWebLoaded) {
  window.dsLottieWebLoaded = true;
  const s = document.createElement("script");
  s.src = "https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js";
  s.defer = true;
  document.head.appendChild(s);
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const wrapper   = document.getElementById("ds-scroll-{{ section.id }}");
  const container = document.getElementById("ds-lottie-{{ section.id }}");

  if (!wrapper || !container) return;

  let anim = null;
  let currentMode = null;

  const desktopJSON = "{{ section.settings.lottie_url_desktop }}";
  const mobileJSON  = "{{ section.settings.lottie_url_mobile }}";

  function getMode() {
    return window.matchMedia("(max-width: 767px)").matches
      ? "mobile"
      : "desktop";
  }

  function getJSON() {
    return getMode() === "mobile" ? mobileJSON : desktopJSON;
  }

  function destroyAnim() {
    if (anim) {
      anim.destroy();
      anim = null;
      container.innerHTML = "";
    }
  }

  function initLottie() {
    if (!window.lottie) {
      requestAnimationFrame(initLottie);
      return;
    }

    const mode = getMode();
    if (mode === currentMode) return;

    currentMode = mode;
    destroyAnim();

    anim = lottie.loadAnimation({
      container: container,
      renderer: "svg",
      loop: false,
      autoplay: false,
      path: getJSON()
    });

    anim.addEventListener("DOMLoaded", () => {
      window.addEventListener("scroll", onScroll, { passive: true });
      onScroll();
    });
  }

  function o
