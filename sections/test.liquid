{% comment %}
DS Scroll Scrub Lottie
Desktop + Mobile JSON support
Uses lottie-web + scroll position mapping
{% endcomment %}

<style>
#shopify-section-{{ section.id }} .ds-scroll-wrapper {
  height: {{ section.settings.scroll_height }}vh;
  position: relative;
}

#shopify-section-{{ section.id }} .ds-lottie-sticky {
  position: sticky;
  top: 0;
  height: 100vh;
  overflow: hidden;
}

#shopify-section-{{ section.id }} .ds-lottie-container {
  width: 100%;
  height: 100%;
}
.ds-scroll-wrapper{
    position: relative;
}
.ds-scroll-wrapper:before {
    background: linear-gradient(183.3deg, #1a1a1a  27.45%, rgba(26, 26, 26, 0) 92.18%);
    height: 150px;
    width: 100%;
    position: absolute;
    top: 0px;
    display: block;
    content: "";
    z-index: 5;
}
.ds-scroll-wrapper:after {
    background: linear-gradient(183.3deg,rgba(26, 26, 26, 0)  27.45%,  #1a1a1a 92.18%);
    height: 150px;
    width: 100%;
    position: absolute;
    bottom: 0px;
    display: block;
    content: "";
    z-index: 5;
}
</style>

<section class="ds-scroll-lottie-section">
  <div id="ds-scroll-{{ section.id }}" class="ds-scroll-wrapper">
    <div class="ds-lottie-sticky">
      <div
        id="ds-lottie-{{ section.id }}"
        class="ds-lottie-container">
      </div>
    </div>
  </div>
</section>

<!-- Load lottie-web ONCE -->
<script>
if (!window.dsLottieWebLoaded) {
  window.dsLottieWebLoaded = true;
  const s = document.createElement("script");
  s.src = "https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js";
  s.defer = true;
  document.head.appendChild(s);
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const wrapper   = document.getElementById("ds-scroll-{{ section.id }}");
  const container = document.getElementById("ds-lottie-{{ section.id }}");

  if (!wrapper || !container) return;

  let anim = null;
  let currentMode = null;

  const desktopJSON = "{{ section.settings.lottie_url_desktop }}";
  const mobileJSON  = "{{ section.settings.lottie_url_mobile }}";

  function getMode() {
    return window.matchMedia("(max-width: 767px)").matches
      ? "mobile"
      : "desktop";
  }

  function getJSON() {
    return getMode() === "mobile" ? mobileJSON : desktopJSON;
  }

  function destroyAnim() {
    if (anim) {
      anim.destroy();
      anim = null;
      container.innerHTML = "";
    }
  }

  function initLottie() {
    if (!window.lottie) {
      requestAnimationFrame(initLottie);
      return;
    }

    const mode = getMode();
    if (mode === currentMode) return;

    currentMode = mode;
    destroyAnim();

    anim = lottie.loadAnimation({
      container: container,
      renderer: "svg",
      loop: false,
      autoplay: false,
      path: getJSON()
    });

    anim.addEventListener("DOMLoaded", () => {
      window.addEventListener("scroll", onScroll, { passive: true });
      onScroll();
    });
  }

  function onScroll() {
    if (!anim) return;

    const rect = wrapper.getBoundingClientRect();
    const progress =
      1 - rect.bottom / (window.innerHeight + rect.height);

    const clamped = Math.min(Math.max(progress, 0), 1);
    const frame = clamped * (anim.totalFrames - 1);

    anim.goToAndStop(frame, true);
  }

  // Init
  initLottie();

  // Re-init on breakpoint change
  window.addEventListener("resize", () => {
    clearTimeout(window.__dsLottieResize);
    window.__dsLottieResize = setTimeout(initLottie, 200);
  });

});
</script>

{% schema %}
{
  "name": "DS Scroll Scrub Lottie",
  "settings": [
    {
      "type": "text",
      "id": "lottie_url_desktop",
      "label": "Desktop Lottie JSON URL"
    },
    {
      "type": "text",
      "id": "lottie_url_mobile",
      "label": "Mobile Lottie JSON URL"
    },
    {
      "type": "range",
      "id": "scroll_height",
      "label": "Scroll Height (vh)",
      "min": 100,
      "max": 500,
      "step": 50,
      "default": 300
    }
  ],
  "presets": [
    {
      "name": "DS Scroll Scrub Lottie"
    }
  ]
}
{% endschema %}
