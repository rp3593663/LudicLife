{%- if section.settings.layout == 'box_width' -%}
  {%- assign container = 'container' -%}
{%- else -%}
  {%- assign container = 'container-fluid' -%}
{%- endif -%}

{% assign padding = section.settings.padding | split: "|" %}
{% assign margin  = section.settings.margin  | split: "|" %}

{%- style -%}
#shopify-section-{{ section.id }} .section--ds-moto-lottie{
  {% if padding[0] != blank %}padding: {{ padding[0] }};{% endif %}
  {% if margin[0]  != blank %}margin: {{ margin[0] }};{% endif %}
}

@media (max-width:1199px){
  #shopify-section-{{ section.id }} .section--ds-moto-lottie{
    {% if padding[1] != blank %}padding: {{ padding[1] }};{% endif %}
    {% if margin[1]  != blank %}margin: {{ margin[1] }};{% endif %}
  }
}

@media (max-width:991px){
  #shopify-section-{{ section.id }} .section--ds-moto-lottie{
    {% if padding[2] != blank %}padding: {{ padding[2] }};{% endif %}
    {% if margin[2]  != blank %}margin: {{ margin[2] }};{% endif %}
  }
}

@media (max-width:767px){
  #shopify-section-{{ section.id }} .section--ds-moto-lottie{
    {% if padding[3] != blank %}padding: {{ padding[3] }};{% endif %}
    {% if margin[3]  != blank %}margin: {{ margin[3] }};{% endif %}
  }
}

.ds-moto-lottie{
  margin: 0 auto;
  overflow: hidden;
}

.ds-moto-lottie lottie-player{
  width: 100%;
  height: 100vh;
}
section.ludic-section.section--ds-moto-lottie.lottie_frame:before {
    background: linear-gradient(183.3deg, #1a1a1a  27.45%, rgba(26, 26, 26, 0) 92.18%);
    height: 150px;
    width: 100%;
    position: absolute;
    top: 0px;
    display: block;
    content: "";
    z-index: 5;
}
section.ludic-section.section--ds-moto-lottie.lottie_frame {
    position: relative;
}
section.ludic-section.section--ds-moto-lottie.lottie_frame:after {
    background: linear-gradient(183.3deg,rgba(26, 26, 26, 0)  27.45%,  #1a1a1a 92.18%);
    height: 150px;
    width: 100%;
    position: absolute;
    bottom: 0px;
    display: block;
    content: "";
    z-index: 5;
}
{%- endstyle -%}

<section class="ludic-section section--ds-moto-lottie {{ section.settings.custom_class }}">
  <div class="{{ container }}">
    <div class="ds-moto-lottie">
      <lottie-player
        id="dsMotoLottie-{{ section.id }}"
        src="https://cdn.shopify.com/s/files/1/0823/6787/3328/files/mobile-lottie.json?v=1766404097"
        background="transparent"
        speed="1"
        autoplay>
      </lottie-player>
    </div>
  </div>
</section>

<!-- Load Lottie Player ONCE -->
<script>
if (!window.lottiePlayerLoaded) {
  window.lottiePlayerLoaded = true;
  const script = document.createElement('script');
  script.src = "https://unpkg.com/@lottiefiles/lottie-player@1.7.1/dist/lottie-player.js";
  script.defer = true;
  document.head.appendChild(script);
}
</script>

<!-- Load GSAP + ScrollTrigger ONCE -->
<script>
if (!window.gsapLoaded) {
  window.gsapLoaded = true;

  const gsapScript = document.createElement('script');
  gsapScript.src = "https://unpkg.com/gsap@3/dist/gsap.min.js";
  gsapScript.defer = true;

  const stScript = document.createElement('script');
  stScript.src = "https://unpkg.com/gsap@3/dist/ScrollTrigger.min.js";
  stScript.defer = true;

  document.head.appendChild(gsapScript);
  document.head.appendChild(stScript);
}
</script>

<!-- Sticky until Lottie animation completes -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const section = document.querySelector(
    "#shopify-section-{{ section.id }} .section--ds-moto-lottie"
  );
  const lottiePlayer = document.getElementById("dsMotoLottie-{{ section.id }}");

  if (!section || !lottiePlayer) return;

  function initStickyLottie() {
    if (!window.gsap || !window.ScrollTrigger || !lottiePlayer.getLottie) {
      setTimeout(initStickyLottie, 100);
      return;
    }

    gsap.registerPlugin(ScrollTrigger);

    const lottieAnim = lottiePlayer.getLottie();
    lottieAnim.loop = false;

    const totalFrames = lottieAnim.totalFrames;
    const frameRate = lottieAnim.frameRate || 60;
    const duration = totalFrames / frameRate;

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: "top top",
        end: `+=${duration * 1000}`,
        scrub: true,
        pin: true,
        anticipatePin: 1
      }
    });

    tl.to({}, {
      duration: duration,
      onUpdate: function () {
        const frame = Math.floor(tl.progress() * totalFrames);
        lottieAnim.goToAndStop(frame, true);
      }
    });
  }

  initStickyLottie();
});
</script>

{% schema %}
{
  "name": "DS Moto Lottie",
  "settings": [
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "default": "box_width",
      "options": [
        { "value": "full-width", "label": "Full Width" },
        { "value": "box_width", "label": "Box Width" }
      ]
    },
    {
      "type": "text",
      "id": "padding",
      "label": "Padding",
      "default": "0px 0px 0px 0px",
      "info": "Desktop | 1200px | 991px | 767px"
    },
    {
      "type": "text",
      "id": "margin",
      "label": "Margin",
      "default": "80px 0px | | | 36px 0px",
      "info": "Desktop | 1200px | 991px | 767px"
    },
    {
      "type": "text",
      "id": "custom_class",
      "label": "Custom Class"
    }
  ],
  "presets": [
    {
      "name": "DS Moto Lottie"
    }
  ]
}
{% endschema %}
